<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoW Server Stats Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --color-gold: #ffb100;
            --color-gold-hover: #ffe099;
            --panel-bg: rgba(10, 10, 10, 0.98);
            --border-gold: #3e3324;
            --font-main: "Segoe UI", Tahoma, sans-serif;
        }

        body {
            background: #050505 url('https://worldofwarcraft.blizzard.com/static/components/Backdrop/Backdrop-dark.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #f0ebe0;
            font-family: var(--font-main);
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--panel-bg);
            border: 2px solid var(--border-gold);
            padding: 40px;
            box-shadow: 0 0 60px rgba(0,0,0,1);
        }

        h1 {
            text-align: center;
            color: var(--color-gold);
            text-transform: uppercase;
            font-size: 2.4rem;
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 40px;
        }

        .filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid #333;
            padding: 25px;
            margin-bottom: 40px;
            align-items: end;
        }

        .filter-group { display: flex; flex-direction: column; }
        .filter-group label {
            color: var(--color-gold);
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        select {
            background: #151515;
            color: white;
            border: 1px solid var(--border-gold);
            padding: 12px;
            font-size: 1rem;
            cursor: pointer;
        }

        .search-btn {
            background: linear-gradient(to bottom, #4e3a23, #2a1d0d);
            color: var(--color-gold);
            border: 1px solid var(--color-gold);
            padding: 12px;
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.2s ease;
            height: 48px;
        }

        .search-btn:hover {
            filter: brightness(1.3);
            box-shadow: 0 0 15px rgba(255, 177, 0, 0.4);
        }

        .search-btn:disabled {
            filter: grayscale(1);
            cursor: not-allowed;
            color: #888;
        }

        .results-area { display: none; }

        .chart-box {
            margin-bottom: 60px;
            background: rgba(0,0,0,0.2);
            padding: 25px;
            border: 1px solid #222;
        }

        h2 {
            color: var(--color-gold);
            font-size: 1.8rem;
            border-left: 5px solid var(--color-gold);
            padding: 0 0 0 15px;
            margin-bottom: 35px;
        }

        .total-badge {
            text-align: center;
            font-size: 1.6rem;
            margin-bottom: 30px;
            color: #ccc;
        }

        .total-badge span { color: var(--color-gold); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Server Population Stats</h1>

    <div class="filter-form">
        <div class="filter-group">
            <label>Realm</label>
            <select id="realmSelect"><option value="Onyxia">Onyxia</option></select>
        </div>
        <div class="filter-group">
            <label>Faction</label>
            <select id="factionSelect">
                <option value="">All Factions</option>
                <option value="Horde">Horde</option>
                <option value="Alliance">Alliance</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Race</label>
            <select id="raceSelect"><option value="">All Races</option></select>
        </div>
        <div class="filter-group">
            <label>Class</label>
            <select id="classSelect"><option value="">All Classes</option></select>
        </div>
        <button class="search-btn" id="fetchBtn" onclick="fetchStats()">Get Stats</button>
    </div>

    <div id="resultsArea" class="results-area">
        <div class="total-badge">Characters Found: <span id="countVal">0</span></div>
        
        <div class="chart-box"><h2>Factions</h2><canvas id="factionChart"></canvas></div>
        <div class="chart-box"><h2>Races</h2><canvas id="raceChart"></canvas></div>
        <div class="chart-box"><h2>Classes</h2><canvas id="classChart"></canvas></div>
    </div>
</div>

<script>
    const API_URL = 'https://emikseoakgajjwflivva.supabase.co/functions/v1/get-stats';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVtaWtzZW9ha2dhamp3ZmxpdnZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzODMwOTcsImV4cCI6MjA4MTk1OTA5N30.497WMmn_pSOb-3KnQ9Vai7-wi2F6XLyUfx6bNsSd5WU';

    const CLASS_COLORS = {
        'Paladin': '#F58CBA', 'Mage': '#3FC7EB', 'Hunter': '#ABD473', 'Warlock': '#8787ED',
        'Shaman': '#0070DE', 'Druid': '#FF7D0A', 'Priest': '#FFFFFF', 'Rogue': '#FFF569', 'Warrior': '#C79C6E'
    };

    const RACES = ["Blood Elf", "Draenei", "Dwarf", "Gnome", "Human", "Night Elf", "Orc", "Tauren", "Troll", "Undead"];
    const CLASSES = ["Death Knight", "Druid", "Hunter", "Mage", "Paladin", "Priest", "Rogue", "Shaman", "Warlock", "Warrior"];
    
    RACES.forEach(r => document.getElementById('raceSelect').add(new Option(r, r)));
    CLASSES.forEach(c => document.getElementById('classSelect').add(new Option(c, c)));

    Chart.register(ChartDataLabels);
    let charts = {};

    function getChartConfig() {
        return {
            type: 'bar',
            data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        bodyFont: { size: 18 },
                        titleFont: { size: 18 }
                    },
                    datalabels: {
                        color: '#fff', anchor: 'end', align: 'top', offset: 5,
                        font: { weight: 'bold', size: 16 },
                        formatter: (val, ctx) => {
                            const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            return sum > 0 ? ((val / sum) * 100).toFixed(1) + '%' : '';
                        }
                    }
                },
                onHover: (event, chartElement) => {
                    event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                },
                scales: {
                    x: { ticks: { color: '#bbb', font: { size: 14, weight: '600' } }, grid: { display: false } },
                    y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#888' } }
                }
            }
        };
    }

    async function fetchStats() {
        const btn = document.getElementById('fetchBtn');
        const resultsArea = document.getElementById('resultsArea');
        
        const params = new URLSearchParams({
            realm: document.getElementById('realmSelect').value,
            faction: document.getElementById('factionSelect').value,
            race: document.getElementById('raceSelect').value,
            class: document.getElementById('classSelect').value
        });
        [...params.entries()].forEach(([k, v]) => !v && params.delete(k));

        try {
            // Визуальный эффект загрузки
            btn.disabled = true;
            btn.innerText = "Loading...";

            const res = await fetch(`${API_URL}?${params}`, {
                method: 'GET',
                headers: { 'apikey': ANON_KEY, 'Authorization': `Bearer ${ANON_KEY}` }
            });

            if (!res.ok) throw new Error('API unreachable');
            const data = await res.json();

            // Для пустых данных
            if (data.total === 0) {
                alert("No characters found with these filters. Try to broaden your search!");
                resultsArea.style.display = 'none';
                return;
            }

            resultsArea.style.display = 'block';
            document.getElementById('countVal').innerText = data.total.toLocaleString();

            if (!charts.f) {
                charts.f = new Chart(document.getElementById('factionChart'), getChartConfig());
                charts.r = new Chart(document.getElementById('raceChart'), getChartConfig());
                charts.c = new Chart(document.getElementById('classChart'), getChartConfig());
            }

            const brighten = (hex) => hex === '#FFFFFF' ? '#e0e0e0' : hex; // Для жрецов чуть приглушаем основной, чтобы ярче светился при наведении

            updateChart(charts.f, data.factions, (i) => i.name === 'Horde' ? '#8c1616' : '#004a94');
            updateChart(charts.r, data.races, () => '#d4a137');
            updateChart(charts.c, data.classes, (i) => CLASS_COLORS[i.name] || '#999');

        } catch (e) {
            console.error(e);
            alert("Error connecting to server.");
        } finally {
            btn.disabled = false;
            btn.innerText = "Get Stats";
        }
    }

    function updateChart(chart, data, colorFn) {
        const baseColors = data.map(colorFn);
        chart.data.labels = data.map(d => d.name);
        chart.data.datasets[0].data = data.map(d => d.count);
        chart.data.datasets[0].backgroundColor = baseColors;
        
        // Эффект яркой подсветки при наведении
        chart.options.plugins.tooltip.callbacks = {
            labelColor: function(context) {
                return { backgroundColor: context.dataset.backgroundColor[context.dataIndex] };
            }
        };
        
        // Авто-генерация цвета для Hover (осветление)
        chart.data.datasets[0].hoverBackgroundColor = baseColors.map(c => adjustColor(c, 40));
        chart.update();
    }

    // Вспомогательная функция для осветления HEX цвета
    function adjustColor(hex, amt) {
        let col = hex.replace('#', '');
        let r = parseInt(col.substring(0,2), 16) + amt;
        let g = parseInt(col.substring(2,4), 16) + amt;
        let b = parseInt(col.substring(4,6), 16) + amt;
        r = Math.min(255, Math.max(0, r));
        g = Math.min(255, Math.max(0, g));
        b = Math.min(255, Math.max(0, b));
        return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
    }
</script>
</body>
</html>