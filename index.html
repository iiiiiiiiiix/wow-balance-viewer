<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoW Server Stats Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --color-gold: #ffb100;
            --panel-bg: rgba(12, 12, 12, 0.98);
            --border-gold: #3e3324;
            --disabled-bg: #2a2a2a;
            --disabled-text: #666;
        }

        body {
            background: #050505 url('https://worldofwarcraft.blizzard.com/static/components/Backdrop/Backdrop-dark.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #f0ebe0;
            font-family: "Segoe UI", Tahoma, sans-serif;
            margin: 0; padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--panel-bg);
            border: 2px solid var(--border-gold);
            padding: 30px;
            box-shadow: 0 0 50px rgba(0,0,0,1);
        }

        h1 {
            text-align: center;
            color: var(--color-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 30px;
        }
        h2 {
            align-self: flex-start;
            color: var(--color-gold);
            font-size: 1.1rem;
            border-left: 4px solid var(--color-gold);
            padding-left: 12px;
            text-transform: uppercase;
            margin-bottom: 25px;
        }
        /* Фильтры */
        .filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-gold);
        }

        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label {
            color: var(--color-gold);
            font-size: 11px;
            text-transform: uppercase;
            font-weight: bold;
        }

        select, .search-btn {
            background: #1a1a1a;
            color: #fff;
            border: 1px solid var(--border-gold);
            padding: 10px;
            font-size: 14px;
        }

        .search-btn {
            background: linear-gradient(to bottom, #4e3a23, #2a1d0d);
            color: var(--color-gold);
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 18px;
            border: 1px solid var(--color-gold);
            transition: all 0.2s;
        }
        .search-btn:hover:not(:disabled) { filter: brightness(1.3); box-shadow: 0 0 10px rgba(255, 177, 0, 0.3); }
        .search-btn:disabled {
            background: var(--disabled-bg);
            color: var(--disabled-text);
            border-color: #444;
            cursor: not-allowed;
            filter: none;
        }
        /* Анимация точек */
        .loading-text::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80% { content: '...'; }
        }
        .chart-section {
            margin-bottom: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .chart-wrapper {
            position: relative;
            margin: 0 auto;
            width: 100%; /* По умолчанию на всю ширину */
            max-width: 600px; /* Но не шире этого значения на десктопе */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .chart-wrapper::-webkit-scrollbar {
            display: none; /* Скрываем скроллбар в Chrome/Safari */
        }
        canvas {
            width: 100% !important; /* Chart.js сам будет управлять отрисовкой */
            height: 220px !important;
        }
        /* Контейнер для иконок */
        .icons-row {
            display: flex;
            justify-content: space-between; /* Важно для выравнивания по сетке */
            width: 100%;
            margin-top: 10px;
            position: relative;
        }
        .icon-box {
            position: absolute; /* Будем позиционировать иконки точно по пикселям */
            transform: translateX(-50%); /* Центрируем иконку относительно точки */
            display: flex;
            justify-content: center;
        }
        .wow-icon-circle {
            width: 32px; height: 32px;
            border-radius: 50%;
            border: 1px solid var(--color-gold);
            background: #000;
            object-fit: cover;
        }

        /* Фракции */
        .faction-row {
            display: flex; align-items: center;
            width: 100%; max-width: 500px;
            gap: 15px; margin-bottom: 15px;
        }

        .results-area { display: none; }
        .total-badge { text-align: center; font-size: 1.4rem; margin-bottom: 30px; }
        .total-badge span { color: var(--color-gold); font-weight: bold; }

        @media (max-width: 600px) {
            .search-btn { margin-top: 0; }
            .wow-icon-circle { width: 24px; height: 24px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Whitemane Statistics</h1>

    <div class="filter-form">
        <div class="filter-group">
            <label>Realm</label>
            <select id="realmSelect"><option value="Onyxia">Onyxia</option></select>
        </div>
        <div class="filter-group">
            <label>Faction</label>
            <select id="factionSelect">
                <option value="">All Factions</option>
                <option value="Horde">Horde</option>
                <option value="Alliance">Alliance</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Race</label>
            <select id="raceSelect"><option value="">All Races</option></select>
        </div>
        <div class="filter-group">
            <label>Class</label>
            <select id="classSelect"><option value="">All Classes</option></select>
        </div>
        <button class="search-btn" onclick="fetchStats()" id="fetchBtn">Get Stats</button>
    </div>

    <div id="resultsArea" class="results-area">
        <div class="total-badge">Characters Found: <span id="countVal">0</span></div>
        
        <div class="chart-section">
            <h2>Factions Balance</h2>
            <div id="factionList" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        </div>

        <div class="chart-section">
            <h2>Races Distribution</h2>
            <div class="chart-wrapper" id="raceWrapper">
                <canvas id="raceChart" height="220"></canvas>
                <div id="raceIcons" class="icons-row"></div>
            </div>
        </div>

        <div class="chart-section">
            <h2>Classes Distribution</h2>
            <div class="chart-wrapper" id="classWrapper">
                <canvas id="classChart" height="220"></canvas>
                <div id="classIcons" class="icons-row"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://emikseoakgajjwflivva.supabase.co/functions/v1/get-stats';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVtaWtzZW9ha2dhamp3ZmxpdnZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzODMwOTcsImV4cCI6MjA4MTk1OTA5N30.497WMmn_pSOb-3KnQ9Vai7-wi2F6XLyUfx6bNsSd5WU';

    const ICONS = {
        'Horde': 'https://wow.zamimg.com/images/wow/icons/large/ui_hordeicon.jpg',
        'Alliance': 'https://wow.zamimg.com/images/wow/icons/large/ui_allianceicon.jpg',
        'Warrior': 'https://wow.zamimg.com/images/wow/icons/large/classicon_warrior.jpg',
        'Paladin': 'https://wow.zamimg.com/images/wow/icons/large/classicon_paladin.jpg',
        'Hunter': 'https://wow.zamimg.com/images/wow/icons/large/classicon_hunter.jpg',
        'Rogue': 'https://wow.zamimg.com/images/wow/icons/large/classicon_rogue.jpg',
        'Priest': 'https://wow.zamimg.com/images/wow/icons/large/classicon_priest.jpg',
        'Shaman': 'https://wow.zamimg.com/images/wow/icons/large/classicon_shaman.jpg',
        'Mage': 'https://wow.zamimg.com/images/wow/icons/large/classicon_mage.jpg',
        'Warlock': 'https://wow.zamimg.com/images/wow/icons/large/classicon_warlock.jpg',
        'Druid': 'https://wow.zamimg.com/images/wow/icons/large/classicon_druid.jpg',
        'Human': 'https://wow.zamimg.com/images/wow/icons/large/race_human_male.jpg',
        'Orc': 'https://wow.zamimg.com/images/wow/icons/large/race_orc_male.jpg',
        'Dwarf': 'https://wow.zamimg.com/images/wow/icons/large/race_dwarf_male.jpg',
        'Night Elf': 'https://wow.zamimg.com/images/wow/icons/large/race_nightelf_male.jpg',
        'Undead': 'https://wow.zamimg.com/images/wow/icons/large/achievement_character_undead_male.jpg',
        'Tauren': 'https://wow.zamimg.com/images/wow/icons/large/race_tauren_male.jpg',
        'Gnome': 'https://wow.zamimg.com/images/wow/icons/large/race_gnome_male.jpg',
        'Troll': 'https://wow.zamimg.com/images/wow/icons/large/race_troll_male.jpg',
        'Blood Elf': 'https://wow.zamimg.com/images/wow/icons/large/race_bloodelf_male.jpg',
        'Draenei': 'https://wow.zamimg.com/images/wow/icons/large/race_draenei_male.jpg'
    };

    const CLASS_COLORS = {
        'Paladin': '#F58CBA', 'Mage': '#3FC7EB', 'Hunter': '#ABD473', 'Warlock': '#8787ED',
        'Shaman': '#0070DE', 'Druid': '#FF7D0A', 'Priest': '#FFFFFF', 'Rogue': '#FFF569', 'Warrior': '#C79C6E'
    };

    const RACES = ["Blood Elf", "Draenei", "Dwarf", "Gnome", "Human", "Night Elf", "Orc", "Tauren", "Troll", "Undead"];
    const CLASSES = ["Druid", "Hunter", "Mage", "Paladin", "Priest", "Rogue", "Shaman", "Warlock", "Warrior"];
    
    RACES.forEach(r => document.getElementById('raceSelect').add(new Option(r, r)));
    CLASSES.forEach(c => document.getElementById('classSelect').add(new Option(c, c)));

    Chart.register(ChartDataLabels);
    let charts = {};

    async function fetchStats() {
        const btn = document.getElementById('fetchBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-text">Loading</span>';
        // btn.innerText = "LOADING...";
        try {
            const query = new URLSearchParams();
            ['realmSelect','factionSelect','raceSelect','classSelect'].forEach(id => {
                const val = document.getElementById(id).value;
                if(val) query.append(id.replace('Select',''), val);
            });

            const res = await fetch(`${API_URL}?${query.toString()}`, { 
                headers: { 'apikey': ANON_KEY, 'Authorization': `Bearer ${ANON_KEY}` } 
            });
            const data = await res.json();

            if (!data || data.total === 0) {
                alert("No characters found with these filters!");
                return;
            }

            document.getElementById('resultsArea').style.display = 'block';
            document.getElementById('countVal').innerText = data.total.toLocaleString();

            renderFactions(data.factions || []);
            renderVChart('raceChart', 'raceIcons', 'raceWrapper', data.races, () => '#d4a137');
            renderVChart('classChart', 'classIcons', 'classWrapper', data.classes, (i) => CLASS_COLORS[i.name] || '#999');

        } catch (e) {
            console.error(e);
        } finally { btn.disabled = false; btn.innerText = "Get Stats"; }
    }

    function renderFactions(factions) {
        const container = document.getElementById('factionList');
        container.innerHTML = '';
        const total = factions.reduce((a, b) => a + b.count, 0);
        factions.forEach(f => {
            const perc = ((f.count / total) * 100).toFixed(1);
            const color = f.name === 'Horde' ? '#8c1616' : '#004a94';
            const row = document.createElement('div');
            row.className = 'faction-row';
            row.innerHTML = `
                <img src="${ICONS[f.name]}" class="wow-icon-circle">
                <div style="flex-grow:1; background:#222; height:24px; position:relative; border:1px solid #333;">
                    <div style="width:${perc}%; background:${color}; height:100%;"></div>
                    <span style="position:absolute; right:10px; top:0; font-size:12px; font-weight:bold; line-height:24px; text-shadow:1px 1px 2px #000;">
                        ${f.name}: ${perc}% (${f.count.toLocaleString()})
                    </span>
                </div>`;
            container.appendChild(row);
        });
    }

    function renderVChart(canvasId, iconId, wrapperId, data, colorFn) {
        if (!data || !data.length) return;

        const canvas = document.getElementById(canvasId);
        if (charts[canvasId]) charts[canvasId].destroy();

        // Создаем график
        charts[canvasId] = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: data.map(d => d.name),
                datasets: [{
                    data: data.map(d => d.count),
                    backgroundColor: data.map(colorFn),
                    // Убираем barThickness, используем categoryPercentage
                    categoryPercentage: 0.8, 
                    barPercentage: 0.9,
                    borderRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    // Ждем окончания анимации, чтобы правильно расставить иконки
                    onComplete: () => positionIcons(charts[canvasId], iconId, data)
                },
                layout: { padding: { top: 25, bottom: 0 } },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        color: '#fff',
                        anchor: 'end',
                        align: 'top',
                        font: { weight: 'bold', size: 10 },
                        formatter: (val, ctx) => {
                            const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            return ((val / sum) * 100).toFixed(1) + '%';
                        }
                    }
                },
                scales: {
                    x: { display: false },
                    y: { display: false, beginAtZero: true }
                }
            }
        });

        // Функция для точного позиционирования иконок
        function positionIcons(chart, iconContainerId, items) {
            const iconContainer = document.getElementById(iconContainerId);
            iconContainer.innerHTML = '';
            
            // Получаем метаданные отрисованных столбцов
            const meta = chart.getDatasetMeta(0);
            
            items.forEach((item, index) => {
                const columnCenter = meta.data[index].x; // Центр столбика в px
                
                const box = document.createElement('div');
                box.className = 'icon-box';
                box.style.left = columnCenter + 'px'; // Ставим иконку точно по центру
                box.innerHTML = `<img src="${ICONS[item.name]}" class="wow-icon-circle" title="${item.name}">`;
                iconContainer.appendChild(box);
            });
        }

        // Обработка изменения размера окна (перепозиционирование иконок)
        window.addEventListener('resize', () => {
            if(charts[canvasId]) positionIcons(charts[canvasId], iconId, data);
        });
    }

</script>
</body>
</html>
